{% set t = testimonials ?? page.header.testimonials ?? {} %}
{% set enabled = t.enabled is not defined or t.enabled %}
{% set all_items = (t.items ?? []) %}
{% set total = all_items|length %}

{% if enabled and total > 0 %}
  {# Pick one testimonial based on current month (1â€“12) #}
  {% set month_number = "now"|date('n') %} {# 1 = January, 12 = December #}
  {% set index = (month_number - 1) % total %}
  {% set item = all_items[index] %}

  {% if not item %}
    {# Safety guard: if for some reason there is no item, do not render #}
  {% else %}
    {% set background_image = t.background_image ?? null %}
    {% set label = t.label ?? null %}
    {% set title = t.title ?? null %}
    {% set subtitle = t.subtitle ?? null %}

    {# Avatar #}
    {% set avatar = item.avatar ?? null %}
    {% if avatar %}
      {% if page.media[avatar] is defined %}
        {% set avatar_src = page.media[avatar].url %}
      {% else %}
        {% set avatar_src = avatar %}
      {% endif %}
    {% endif %}

    <section class="relative bg-neutral-100 py-12 px-12 md:py-20 md:px-0 overflow-hidden">
      {# Subtle background image #}
      {% if background_image %}
        {% if page.media[background_image] is defined %}
          {% set bg_src = page.media[background_image].url %}
        {% else %}
          {% set bg_src = background_image %}
        {% endif %}
        <div
          class="absolute inset-0 pointer-events-none opacity-10"
          style="
            background-image: url('{{ url(bg_src) }}');
            background-size: cover;
            background-position: center;
          "
        ></div>
      {% endif %}

      <div class="relative max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row items-start gap-10 md:gap-12">
          {# Left column: section heading #}
          <div class="md:w-5/12 space-y-4 px-4">
            {% if label %}
              <p
                class="text-xs font-semibold tracking-[0.28em] uppercase text-orange-500"
              >
                {{ label }}
              </p>
            {% endif %}

            {% if title %}
              <h2
                class="text-2xl md:text-3xl lg:text-4xl font-heading font-semibold text-neutral-900"
              >
                {{ title }}
              </h2>
            {% endif %}

            {% if subtitle %}
              <p class="text-sm md:text-base text-neutral-700 max-w-md">
                {{ subtitle }}
              </p>
            {% endif %}
          </div>

          {# Right column: single testimonial card #}
          <div class="md:w-7/12">
            <article class="flex flex-col items-start">
              {# Main testimonial card #}
              <div class="relative bg-neutral-50 rounded-3xl shadow-sm px-6 md:px-8 py-6 md:py-8">
                <div class="flex flex-col gap-4">
                  <img
                    src="{{ url('theme://images/icons/quotes.webp') }}"
                    alt=""
                    class="h-10 w-16 object-contain"
                  />
                  <p class="text-sm md:text-[15px] leading-relaxed text-neutral-700">
                    {{ item.quote }}
                  </p>
                </div>

                {# Tail fixed to the bottom-left of the card #}
                <div
                  class="absolute -bottom-2 left-20 w-5 h-5 bg-neutral-50 rotate-45"
                  style="box-shadow: 0 12px 25px rgba(15, 23, 42, 0.08);"
                ></div>
              </div>

              {# Avatar + name/role outside the card #}
              <div class="mt-6 flex items-center gap-3 pl-10">
                {% if avatar_src %}
                  <img
                    src="{{ url(avatar_src) }}"
                    alt="{{ item.name|e }}"
                    class="h-12 w-12 rounded-full object-cover"
                  />
                {% endif %}

                <div>
                  {% if item.name %}
                    <p class="text-sm font-semibold text-neutral-900">
                      {{ item.name }}
                    </p>
                  {% endif %}

                  {% if item.role %}
                    <p class="text-xs text-orange-500 mt-0.5">
                      {{ item.role }}
                    </p>
                  {% endif %}
                </div>
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>
  {% endif %}
{% endif %}
